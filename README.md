
log-monitor
========
<https://log-monitor.rg.ru>


Докер приложение для анализа логов серверных приложений RG.RU
 

Размещен на: `dockerweb.rgwork.ru:/home/gitupdater/log-monitor-prod`


Предпосылки
------------
Для отслеживания текущего состояния приложений в настоящее время используется программа `monitor` <https://monitor.rh.ru>.
Однако этого недостаточно для понимания того, что происходит или происходило в системе в прошлом.
Обычно работающие приложения пишут логи о событиях происходящих в системе, таких как запросы к серверу, различного рода ошибки,
попытки несанкционированного доступа. Данная программа предназначена для сбора информации хранящейся в логах приложений
и их анализа в разрезе временных интервалов, в том числе в режиме почти реального времени. 
Фраза "почти реального времени" означает что данные для анализа поступает с запозданием требующемся для индексации данных, 
которое составляет несколько секунд.



Принцип работы
--------------
Для посылки сообщений о происходящих событиях приложения могут использовать две схемы:

1. **С использованием filebeat**. В контейнере работающего приложения должна быть запущена программа filebeat, 
   которая следит за файлами логов приложения и посылает новые записи логов в Эластик.
2. **Приложение напрямую посылает информацию** о логируемых событиях в Эластик, возможно с параллельной записью в файл лога. 
   Сделать это возможно с помощью плугинов к logrus <https://github.com/interactive-solutions/go-logrus-elasticsearch>, 
   <https://github.com/sohlich/elogrus>, <https://github.com/go-extras/elogrus> 


Контейнер log-monitor содержит две службы: elk и caddy.
Контейнер Elk состоит содержит три приложения: Elasticsearch, Logstash и Kibana. 

- Elasticsearch предназначен для хранения, поиска и анализа данных логов
- Logstash предназначен для приема, преобразования данных и отправки их в Elasticsearch. 
  Это тяжеловесное и ресурсоемкое Java приложение, функции которого в нашем случае может выполнить filebeat. 
  Поэтому в нашем случае Logstash выключен из стека и приложения посылают информацию напрямую в Эластик.
- Kibana предназначена для представления данных Elasticsearch конечному пользователю в требуемом виде.








<img src="images/ELK.png">


Требования
------


* **Docker**

    Примечание. Поскольку образ sebp / elk основан на  Linux, пользователям Docker для Windows необходимо убедиться, что Docker использует контейнеры Linux.

* **Минимум 4 ГБ RAM выделено для Docker**

    Для работы Elasticsearch требуется как минимум 2 ГБ оперативной памяти.

    Для Mac объем оперативной памяти, выделенной для Docker, можно установить с помощью пользовательского интерфейса

* **A limit on mmap counts equal to 262,144 or more**

    **!!!** Это самая частая причина, по которой Elasticsearch не запускается с момента выпуска Elasticsearch версии 5.

    В Linux используйте sysctl vm.max_map_count на хосте, чтобы просмотреть текущее значение. Обратите внимание, что ограничения должны быть изменены на хосте; они не могут быть изменены из контейнера.

    Если вы используете Docker для Mac, вам потребуется запустить контейнер с переменной среды `MAX_MAP_COUNT`, установленной как минимум в 262144 (с использованием, например, опции `-e` докера), чтобы Elasticsearch установил ограничения на число `mmap` в время запуска.

* **Доступ к TCP-порту 5044 от клиентов, генерирующих логи**


Виртуальная память
-----------

Elasticsearch по умолчанию использует директорию `hybrid mmapfs / niofs` для хранения своих индексов. По умолчанию ограничения  `mmap` слишком малы, что может привести к нехватке памяти.

В Linux вы можете увеличить ограничения, выполнив следующую команду от имени root:

    sysctl -w vm.max_map_count=262144

Чтобы установить это значение навсегда, обновите параметр `vm.max_map_count` в `/etc/sysctl.conf`. Для проверки после перезагрузки, запустите 

    sysctl vm.max_map_count

Пакеты RPM и Debian настроят этот параметр автоматически. Никаких дополнительных настроек не требуется.

<br><br><br>

--------------------------

Код
---
Весь значимый код находится в директории `deploy/`. 


Команды
----

|   |   |
|---|---|
Старт          | `sh/up.sh`
Стоп           | `sh/stop.sh`
Полный останов | `sh/down.sh`
Рестарт        | `sh/restart.sh`
Проверка       | `sh/ps.sh`
Деплой         | `sh/deploy.sh`




READ
----

**queries**

https://dzone.com/articles/23-useful-elasticsearch-example-queries


https://docs.google.com/document/d/1Q1ExyY36btdnTNe5co_pB4UdWNk41gY3rP1geg1LJBo/edit?usp=sharing



